@let document = store.document();

<form [formGroup]="form" class="incident-form">
    <div class="page-container">
        <div routerLink="/tokens/documents" class="back flex-inline">
            <mat-icon>arrow_back</mat-icon> Back to List
        </div>
        @if (document) {
            <div class="body">
                @if (isPhone()) {
                    <div class="tab-controls">
                        <div class="tab-button">
                            <button
                                (click)="selectTab('left')"
                                [class.active]="activeTab() === 'left'">
                                Details
                            </button>
                        </div>
                        <div class="tab-button">
                            <button
                                (click)="selectTab('right')"
                                [class.active]="activeTab() === 'right'">
                                Activity
                            </button>
                        </div>
                    </div>
                }

                @if (!isPhone() || activeTab() === 'left') {
                    <div class="body__left">
                        <div class="section-title">
                            @if (document.name) {
                                <div>
                                    <span class="label">Name</span>
                                    <span>{{ document.name }}</span>
                                </div>
                            }
                        </div>
                        
                        <div class="section-date">
                            @if (document.updated) {
                                <div>
                                    <span class="label">Created</span>
                                    <span>{{ document.updated | date:'MMM d, y, h:mm a' }}</span>
                                </div>
                            }
                        </div>    
                        <div class="section-sensitivity">
                            @if (document.sensitivity) {
                                <div>
                                    <span class="label">Sensitivity</span>
                                    <io-pill
                                        [pill]="document.sensitivity"
                                        [varMap]="sensitivityColors"
                                        [textMap]="sensitivityText">
                                    </io-pill>
                                </div>  
                            }
                        </div>                    
                    </div>
                }

                @if (!isPhone() || activeTab() === 'right') {
                    <div class="body__right">
                        <div class="header">
                            @if (document.location) {
                                <div>
                                    <span class="label">Location</span>
                                    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="location-input">
                                        <textarea matInput
                                            formControlName="location"
                                            cdkTextareaAutosize
                                            cdkAutosizeMinRows="1"
                                            placeholder="Enter Location"
                                            (keydown.enter)="$event.preventDefault()">
                                        </textarea>
                                        @if (form.get('location')?.hasError('required')) {
                                            <mat-error>Location is required</mat-error>
                                        }
                                        @if (form.get('location')?.hasError('maxlength')) {
                                            <mat-error>Location cannot exceed 100 characters</mat-error>
                                        }
                                    </mat-form-field>
                                </div>
                            }
                            @if (document.updated) {
                                <div class="updated">
                                    <span class="label">Last Updated</span>
                                    <span>{{ document.updated | date:'MMM d, y, h:mm a' }}</span>
                                </div>
                            }
                        </div>
                        <div class="wrapper">
                            <div class="section">
                                <div class="section-title">
                                    <span class="label">Related Incidents</span>
                                </div>
                                <div class="related-incidents">
                                    @for (incident of store.relatedIncidents(); track incident.incidentId) {
                                        @if (incident.isActive) {
                                            <a [routerLink]="['/incidents/open', incident.incidentId ]" >{{incident.title}}</a>
                                        }
                                        @else {
                                            <a [routerLink]="['/incidents/closed', incident.incidentId ]" >{{incident.title}}</a>
                                        }
                                    }
                                    @empty {
                                        No Related Incidents Found. 
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        } @else if (store.isLoading()) {
            <io-skeleton-loader [lines]="5" [showTitle]="true"></io-skeleton-loader>
        } @else {
            <div class="empty-state"><mat-icon>info</mat-icon>Document Not Found</div>
        }
    </div>
</form>

<io-action-bar
    [isOpen]="form.dirty"
    [isValid]="form.valid"
    (save)="onSave()"
    (cancel)="onCancel()">
</io-action-bar>