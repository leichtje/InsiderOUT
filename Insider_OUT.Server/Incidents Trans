---IncidentDto

using System;

namespace InsiderOUT.Server.Models.Dto
{
    public class IncidentDto
    {
        public int IncidentId { get; set; }
        public string Title { get; set; }
        public string Desc { get; set; }
        public DateTime Date { get; set; }
        public DateTime Updated { get; set; }
        public string Agent { get; set; }
        public int TokenId { get; set; }
        public string TokenType { get; set; }
        public string Status { get; set; }
        public int? AssignedUserId { get; set; }
        public int? TiedSubjectId { get; set; }
    }

    public class IncidentViewDto
    {
        public IncidentDto Incident { get; set; }
        public TokenDto? Token { get; set; }
        public SubjectDto? Subject { get; set; }
        public UserDto? User { get; set; }
    }
}


---IIncidentService

using InsiderOUT.Server.Models.Dto;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace InsiderOUT.Server.Services
{
    public interface IIncidentService
    {
        Task<IEnumerable<IncidentDto>> GetAllAsync();
        Task<IncidentDto?> GetByIdAsync(int id);
        Task<IncidentViewDto?> GetViewByIdAsync(int id);
        Task<IncidentDto> CreateAsync(IncidentDto dto);
        Task<bool> UpdateAsync(int id, IncidentDto dto);
        Task<bool> DeleteAsync(int id);
    }
}




---IncidentService
using InsiderOUT.Server.Models.Dto;
using Microsoft.EntityFrameworkCore;

namespace InsiderOUT.Server.Services
{
    public class IncidentService : IIncidentService
    {
        private readonly DBContext _db;

        public IncidentService(DBContext db)
        {
            _db = db;
        }

        public async Task<IEnumerable<IncidentDto>> GetAllAsync()
        {
            return await _db.Incidents
                .AsNoTracking()
                .Select(i => new IncidentDto
                {
                    IncidentId = i.IncidentId,
                    Title = i.IncidentTitle,
                    Desc = i.IncidentDescription,
                    Date = i.IncidentCreatedDate,
                    Updated = i.IncidentUpdatedDate,
                    Agent = i.IncidentAgent,
                    TokenId = i.IncidentTokenId,
                    TokenType = i.IncidentTokenType,
                    Status = i.IncidentStatus,
                    AssignedUserId = i.IncidentAssignedUserId,
                    TiedSubjectId = i.IncidentTiedSubjectId
                })
                .ToListAsync();
        }

        public async Task<IncidentDto?> GetByIdAsync(int id)
        {
            var i = await _db.Incidents
                .AsNoTracking()
                .FirstOrDefaultAsync(x => x.IncidentId == id);

            if (i == null) return null;

            return new IncidentDto
            {
                IncidentId = i.IncidentId,
                Title = i.IncidentTitle,
                Desc = i.IncidentDescription,
                Date = i.IncidentCreatedDate,
                Updated = i.IncidentUpdatedDate,
                Agent = i.IncidentAgent,
                TokenId = i.IncidentTokenId,
                TokenType = i.IncidentTokenType,
                Status = i.IncidentStatus,
                AssignedUserId = i.IncidentAssignedUserId,
                TiedSubjectId = i.IncidentTiedSubjectId
            };
        }

        public async Task<IncidentViewDto?> GetViewByIdAsync(int id)
        {
            var incident = await _db.Incidents
                .AsNoTracking()
                .FirstOrDefaultAsync(x => x.IncidentId == id);

            if (incident == null) return null;

            var token = await _db.Tokens
                .AsNoTracking()
                .FirstOrDefaultAsync(t => t.TokenId == incident.IncidentTokenId);

            var subject = incident.IncidentTiedSubjectId.HasValue
                ? await _db.Subjects.AsNoTracking()
                    .FirstOrDefaultAsync(s => s.SubjectId == incident.IncidentTiedSubjectId.Value)
                : null;

            var user = incident.IncidentAssignedUserId.HasValue
                ? await _db.Users.AsNoTracking()
                    .FirstOrDefaultAsync(u => u.UserId == incident.IncidentAssignedUserId.Value)
                : null;

            var incidentDto = new IncidentDto
            {
                IncidentId = incident.IncidentId,
                Title = incident.IncidentTitle,
                Desc = incident.IncidentDescription,
                Date = incident.IncidentCreatedDate,
                Updated = incident.IncidentUpdatedDate,
                Agent = incident.IncidentAgent,
                TokenId = incident.IncidentTokenId,
                TokenType = incident.IncidentTokenType,
                Status = incident.IncidentStatus,
                AssignedUserId = incident.IncidentAssignedUserId,
                TiedSubjectId = incident.IncidentTiedSubjectId
            };

            return new IncidentViewDto
            {
                Incident = incidentDto,

                Token = token == null ? null : new TokenDto
                {
                    TokenId = token.TokenId,
                    TokenType = token.TokenType,
                    TokenSeverity = token.TokenSeverity
                },

                Subject = subject == null ? null : new SubjectDto
                {
                    SubjectId = subject.SubjectId,
                    SubjectFirstName = subject.SubjectFirstName,
                    SubjectLastName = subject.SubjectLastName,
                    SubjectEmail = subject.SubjectEmail,
                    SubjectPhone = subject.SubjectPhone,
                    SubjectDepartment = subject.SubjectDepartment,
                    SubjectRole = subject.SubjectRole,
                    SubjectRiskScore = subject.SubjectRiskScore
                },

                User = user == null ? null : new UserDto
                {
                    UserId = user.UserId,
                    UserFirstName = user.UserFirstName,
                    UserLastName = user.UserLastName,
                    UserEmail = user.UserEmail,
                    UserPhone = user.UserPhone,
                    UserDepartment = user.UserDepartment
                }
            };
        }

        public async Task<IncidentDto> CreateAsync(IncidentDto dto)
        {
            var entity = new Incident
            {
                IncidentTitle = dto.Title,
                IncidentDescription = dto.Desc,
                IncidentCreatedDate = dto.Date,
                IncidentUpdatedDate = dto.Updated,
                IncidentAgent = dto.Agent,
                IncidentTokenId = dto.TokenId,
                IncidentTokenType = dto.TokenType,
                IncidentStatus = dto.Status,
                IncidentAssignedUserId = dto.AssignedUserId,
                IncidentTiedSubjectId = dto.TiedSubjectId
            };

            _db.Incidents.Add(entity);
            await _db.SaveChangesAsync();

            dto.IncidentId = entity.IncidentId;
            return dto;
        }

        public async Task<bool> UpdateAsync(int id, IncidentDto dto)
        {
            var entity = await _db.Incidents.FindAsync(id);
            if (entity == null) return false;

            entity.IncidentTitle = dto.Title;
            entity.IncidentDescription = dto.Desc;
            entity.IncidentCreatedDate = dto.Date;
            entity.IncidentUpdatedDate = dto.Updated;
            entity.IncidentAgent = dto.Agent;
            entity.IncidentTokenId = dto.TokenId;
            entity.IncidentTokenType = dto.TokenType;
            entity.IncidentStatus = dto.Status;
            entity.IncidentAssignedUserId = dto.AssignedUserId;
            entity.IncidentTiedSubjectId = dto.TiedSubjectId;

            await _db.SaveChangesAsync();
            return true;
        }

        public async Task<bool> DeleteAsync(int id)
        {
            var entity = await _db.Incidents.FindAsync(id);
            if (entity == null) return false;

            _db.Incidents.Remove(entity);
            await _db.SaveChangesAsync();
            return true;
        }
    }
}



---IncidentsController

using Microsoft.AspNetCore.Mvc;
using InsiderOUT.Server.Services;
using InsiderOUT.Server.Models.Dto;
using System.Threading.Tasks;

namespace InsiderOUT.Server.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class IncidentsController : ControllerBase
    {
        private readonly IIncidentService _service;

        public IncidentsController(IIncidentService service)
        {
            _service = service;
        }

        [HttpGet]
        public async Task<IActionResult> GetAll()
            => Ok(await _service.GetAllAsync());

        [HttpGet("{id:int}")]
        public async Task<IActionResult> GetById(int id)
        {
            var incident = await _service.GetByIdAsync(id);
            return incident == null ? NotFound() : Ok(incident);
        }

        [HttpGet("{id:int}/view")]
        public async Task<IActionResult> GetViewById(int id)
        {
            var view = await _service.GetViewByIdAsync(id);
            return view == null ? NotFound() : Ok(view);
        }

        [HttpPost]
        public async Task<IActionResult> Create([FromBody] IncidentDto dto)
        {
            if (!ModelState.IsValid) return BadRequest(ModelState);

            var created = await _service.CreateAsync(dto);
            return CreatedAtAction(nameof(GetById),
                new { id = created.IncidentId },
                created);
        }

        [HttpPut("{id:int}")]
        public async Task<IActionResult> Update(int id, [FromBody] IncidentDto dto)
        {
            if (!ModelState.IsValid) return BadRequest(ModelState);

            var ok = await _service.UpdateAsync(id, dto);
            return ok ? NoContent() : NotFound();
        }

        [HttpDelete("{id:int}")]
        public async Task<IActionResult> Delete(int id)
        {
            var ok = await _service.DeleteAsync(id);
            return ok ? NoContent() : NotFound();
        }
    }
}



--Reg
public DbSet<Incident> Incidents { get; set; }


---
